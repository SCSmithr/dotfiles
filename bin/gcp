#!/bin/bash

set -e

OPTIND=1

project=$GOOGLE_PROJECT_ID

while getopts ":p:" opt; do
    case $opt in
        p)
            project=$OPTARG
            ;;
        \?)
            echo "Invalid argument -$OPTARG"
            exit 1
            ;;
        :)
            echo "Option -$OPTARG requires an argument."
            exit 1
            ;;
    esac
done

if [ -z $project ]; then
    echo "Project must be provided"
fi

shift $((OPTIND-1))

select_instance() {
    local prompt=$1
    local instances=$(gcloud compute --project $project instances list --format json | jq -r '.[] | select (.status == "RUNNING") | .name')
    local selected=$(echo "$instances" | fzf +m)
    echo $selected
}

instance_ssh() {
    local selected=$(select_instance ssh)
    gcloud compute --project $project ssh $selected
}

instance_scp() {
    local file=$1
    if [ -z $file ]; then
        echo "file must be provided"
        exit 1
    fi
    local selected=$(select_instance "scp ($file)") 
    gcloud compute --project $project scp --recurse $file $selected:.
}

case $1 in
    "ssh")
        instance_ssh
        ;;
    "scp")
        file=$2
        instance_scp $file
        ;;
esac
