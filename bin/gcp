#!/bin/bash

set -e

OPTIND=1

project=$GOOGLE_PROJECT_ID

while getopts ":p:" opt; do
    case $opt in
        p)
            project=$OPTARG
            ;;
        \?)
            echo "Invalid argument -$OPTARG"
            exit 1
            ;;
        :)
            echo "Option -$OPTARG requires an argument."
            exit 1
            ;;
    esac
done

if [ -z $project ]; then
    echo "Project must be provided"
fi

shift $((OPTIND-1))

select_instance() {
    local instances
    instances=$(gcloud compute --project $project instances list --format json | jq -r '.[] | select (.status == "RUNNING") | .name')
    local selected
    selected=$(echo "$instances" | fzf +m) 
    echo $selected
}

instance_ssh() {
    local selected
    selected=$(select_instance)
    gcloud compute --project $project ssh $selected
}

instance_scp() {
    local file=$1
    if [ -z $file ]; then
        echo "file must be provided"
        exit 1
    fi
    local selected
    selected=$(select_instance) 
    gcloud compute --project $project scp --recurse $file $selected:.
}

instance_exec() {
    local selected
    selected=$(select_instance) 
    gcloud compute --project $project ssh $selected --command="$*"
}

case $1 in
    "ssh")
        shift
        instance_ssh
        ;;
    "scp")
        shift
        instance_scp "$1"
        ;;
    "exec")
        shift
        instance_exec "$@"
        ;;
esac
