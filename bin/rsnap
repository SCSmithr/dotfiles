#!/bin/bash

set -e

if [ "$#" -ne 1 ]; then
    echo "Usage: $(basename $0) <ip or hostname>"
fi
remote_host="$1"

ssh_exec() {
    ssh "$remote_host" "$1"
}

snap_source="/home/$USER/"
snap_dir="/snapshots/$HOSTNAME/$USER"
ssh_exec "mkdir -p $snap_dir"
latest="$snap_dir/latest"
snap_dest="$snap_dir/$(date "+%Y-%b-%d-%T")"

rsync -aPh --link-dest="$latest" -e ssh "$snap_source" "$1":"$snap_dest"

ssh_exec "rm -f $latest"
ssh_exec "ln -s $snap_dest $latest"
